<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>React + shadcn Todo (Hash Share)</title>
    <style>
      :root {
        --background: #f8fafc;
        --foreground: #0f172a;
        --card: #ffffff;
        --card-foreground: #020817;
        --primary: #0f172a;
        --primary-foreground: #f8fafc;
        --secondary: #f1f5f9;
        --secondary-foreground: #0f172a;
        --muted: #f1f5f9;
        --muted-foreground: #64748b;
        --border: #e2e8f0;
        --ring: #94a3b8;
        --destructive: #ef4444;
        --radius: 12px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
        background: radial-gradient(circle at top, #f8fafc, #eef2ff);
        color: var(--foreground);
        font-family: "Inter", "SF Pro Display", "Segoe UI", sans-serif;
      }

      .app-shell {
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 28px 16px;
      }

      .card {
        width: min(760px, 100%);
        background: color-mix(in srgb, var(--card) 92%, #ffffff 8%);
        color: var(--card-foreground);
        border: 1px solid var(--border);
        border-radius: calc(var(--radius) + 2px);
        box-shadow:
          0 20px 50px rgba(15, 23, 42, 0.08),
          0 8px 16px rgba(15, 23, 42, 0.06);
        overflow: hidden;
      }

      .card-header {
        padding: 20px 20px 8px;
      }

      .card-title {
        margin: 0;
        font-size: 1.45rem;
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .card-description {
        margin: 6px 0 0;
        color: var(--muted-foreground);
        font-size: 0.94rem;
      }

      .card-content {
        padding: 14px 20px 20px;
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .input {
        flex: 1;
        height: 40px;
        padding: 0 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--foreground);
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .input:focus {
        border-color: var(--ring);
        box-shadow: 0 0 0 4px rgba(148, 163, 184, 0.2);
      }

      .btn {
        height: 40px;
        border: 1px solid transparent;
        border-radius: 10px;
        padding: 0 14px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.08s, box-shadow 0.15s, opacity 0.2s;
      }

      .btn:active {
        transform: translateY(1px);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: var(--primary);
        color: var(--primary-foreground);
      }

      .btn-primary:hover:not(:disabled) {
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.22);
      }

      .btn-outline {
        background: #fff;
        color: var(--secondary-foreground);
        border-color: var(--border);
      }

      .btn-outline.active {
        background: var(--secondary);
      }

      .btn-ghost {
        background: transparent;
        color: var(--muted-foreground);
      }

      .btn-ghost:hover:not(:disabled) {
        color: var(--foreground);
        background: var(--muted);
      }

      .btn-danger {
        background: transparent;
        color: var(--destructive);
      }

      .btn-danger:hover:not(:disabled) {
        background: rgba(239, 68, 68, 0.1);
      }

      .todo-list {
        list-style: none;
        margin: 14px 0;
        padding: 0;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: #fff;
      }

      .todo-empty {
        margin: 14px 0;
        border: 1px dashed var(--border);
        border-radius: 12px;
        padding: 22px;
        color: var(--muted-foreground);
        text-align: center;
        background: #fff;
      }

      .todo-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        border-top: 1px solid var(--border);
      }

      .todo-item:first-child {
        border-top: 0;
      }

      .todo-item:hover {
        background: color-mix(in srgb, var(--secondary) 40%, #ffffff 60%);
      }

      .todo-check {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .todo-text {
        flex: 1;
        font-size: 14px;
      }

      .todo-text.done {
        color: var(--muted-foreground);
        text-decoration: line-through;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 600;
        background: var(--secondary);
        color: var(--secondary-foreground);
      }

      .hash-hint {
        margin-top: 10px;
        padding: 10px 12px;
        border: 1px dashed var(--border);
        border-radius: 10px;
        color: var(--muted-foreground);
        font-size: 12px;
        background: #fff;
      }

      .footer {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .muted {
        color: var(--muted-foreground);
      }

      .runtime-status {
        width: min(760px, calc(100% - 32px));
        margin: 14px auto 0;
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: color-mix(in srgb, var(--card) 94%, #ffffff 6%);
        color: var(--muted-foreground);
        font-size: 12px;
      }

      @media (max-width: 640px) {
        .card-content,
        .card-header {
          padding-left: 14px;
          padding-right: 14px;
        }

        .row {
          flex-direction: column;
          align-items: stretch;
        }

        .btn {
          width: 100%;
        }

        .footer {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <div id="runtime-status" class="runtime-status">Booting Renderify runtime...</div>
    <div id="app"></div>

    <script type="importmap">
      {
        "imports": {
          "@renderify/ir": "../../packages/ir/dist/ir.esm.js",
          "@renderify/security": "../../packages/security/dist/security.esm.js",
          "preact": "/node_modules/preact/dist/preact.module.js",
          "preact/hooks": "/node_modules/preact/hooks/dist/hooks.module.js",
          "preact/jsx-runtime": "/node_modules/preact/jsx-runtime/dist/jsxRuntime.module.js",
          "preact/jsx-dev-runtime": "/node_modules/preact/jsx-runtime/dist/jsxRuntime.module.js",
          "es-module-lexer": "/node_modules/.pnpm/es-module-lexer@1.7.0/node_modules/es-module-lexer/dist/lexer.js"
        }
      }
    </script>
    <script type="text/plain" id="todo-source">
      import { useEffect, useMemo, useState } from "preact/hooks";

      const HASH_KEY = "state64";
      const DEFAULT_TODOS = [
        { id: "seed-priority", text: "List the top 3 priorities for today", done: false },
        { id: "seed-pr", text: "Review PR #142", done: true },
        { id: "seed-share", text: "Share demo progress with the team", done: false },
      ];

      function uid() {
        return `${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
      }

      function joinClasses(...parts) {
        return parts.filter(Boolean).join(" ");
      }

      function encodeBase64Url(input) {
        const bytes = new TextEncoder().encode(String(input));
        let binary = "";
        for (const byte of bytes) {
          binary += String.fromCharCode(byte);
        }
        return btoa(binary).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
      }

      function decodeBase64Url(input) {
        const normalized = String(input).replace(/-/g, "+").replace(/_/g, "/");
        const padded = normalized + "=".repeat((4 - (normalized.length % 4 || 4)) % 4);
        const binary = atob(padded);
        const bytes = new Uint8Array(binary.length);
        for (let index = 0; index < binary.length; index += 1) {
          bytes[index] = binary.charCodeAt(index);
        }
        return new TextDecoder().decode(bytes);
      }

      function normalizeTodos(value) {
        if (!Array.isArray(value)) return [];
        return value
          .filter((item) => item && typeof item.id === "string" && typeof item.text === "string")
          .map((item) => ({ id: item.id, text: item.text, done: Boolean(item.done) }));
      }

      function normalizeFilter(value) {
        if (value === "active" || value === "done") return value;
        return "all";
      }

      function readHashState() {
        try {
          const rawHash = window.location.hash.startsWith("#")
            ? window.location.hash.slice(1)
            : window.location.hash;
          if (!rawHash) return null;
          const params = new URLSearchParams(rawHash);
          const payload = params.get(HASH_KEY) || params.get("t");
          if (!payload) return null;

          const parsed = JSON.parse(decodeBase64Url(payload));
          if (!parsed || typeof parsed !== "object") return null;
          return {
            todos: normalizeTodos(parsed.todos),
            filter: normalizeFilter(parsed.filter),
          };
        } catch {
          return null;
        }
      }

      function writeHashState(state) {
        const encoded = encodeBase64Url(JSON.stringify(state));
        const params = new URLSearchParams();
        params.set(HASH_KEY, encoded);
        const nextHash = `#${params.toString()}`;
        if (nextHash !== window.location.hash) {
          history.replaceState(null, "", `${window.location.pathname}${window.location.search}${nextHash}`);
        }
      }

      const initialHashState = readHashState();

      export default function App() {
        const [todos, setTodos] = useState(initialHashState?.todos ?? DEFAULT_TODOS);
        const [value, setValue] = useState("");
        const [filter, setFilter] = useState(initialHashState?.filter ?? "all");
        const [flash, setFlash] = useState(initialHashState ? "State restored from hash" : "");

        useEffect(() => {
          writeHashState({ todos, filter });
        }, [todos, filter]);

        useEffect(() => {
          if (!flash) return undefined;
          const timer = setTimeout(() => setFlash(""), 1800);
          return () => clearTimeout(timer);
        }, [flash]);

        useEffect(() => {
          const onHashChange = () => {
            const next = readHashState();
            if (!next) return;
            setTodos(next.todos);
            setFilter(next.filter);
            setFlash("Updated from hash");
          };
          window.addEventListener("hashchange", onHashChange);
          return () => window.removeEventListener("hashchange", onHashChange);
        }, []);

        const leftCount = useMemo(
          () => todos.reduce((count, todo) => count + (todo.done ? 0 : 1), 0),
          [todos],
        );

        const filtered = useMemo(() => {
          if (filter === "active") return todos.filter((todo) => !todo.done);
          if (filter === "done") return todos.filter((todo) => todo.done);
          return todos;
        }, [todos, filter]);

        const addTodo = () => {
          const text = value.trim();
          if (!text) return;
          setTodos((prev) => [{ id: uid(), text, done: false }, ...prev]);
          setValue("");
        };

        const onInputKeyDown = (event) => {
          if (event.key === "Enter") addTodo();
        };

        const toggleTodo = (id) => {
          setTodos((prev) =>
            prev.map((todo) => (todo.id === id ? { ...todo, done: !todo.done } : todo)),
          );
        };

        const removeTodo = (id) => {
          setTodos((prev) => prev.filter((todo) => todo.id !== id));
        };

        const clearDone = () => {
          setTodos((prev) => prev.filter((todo) => !todo.done));
        };

        const resetDemo = () => {
          setTodos([
            { id: uid(), text: "List the top 3 priorities for today", done: false },
            { id: uid(), text: "Review PR #142", done: true },
            { id: uid(), text: "Share demo progress with the team", done: false },
          ]);
          setFilter("all");
          setFlash("Demo reset");
        };

        const copyShareLink = async () => {
          try {
            await navigator.clipboard.writeText(window.location.href);
            setFlash("Share link copied");
          } catch {
            setFlash("Copy failed. Please copy the address bar manually.");
          }
        };

        return (
          <main className="app-shell">
            <section className="card">
              <header className="card-header">
                <h1 className="card-title">React + shadcn Todo (Hash Share RuntimePlan + JSX)</h1>
                <p className="card-description">
                  State syncs to URL hash and is rendered through Renderify runtime JSX source execution.
                </p>
              </header>

              <div className="card-content">
                <div className="row">
                  <input
                    className="input"
                    placeholder="Add a task, e.g. design runtime streaming API"
                    value={value}
                    onInput={(event) => setValue(event.target.value)}
                    onKeyDown={onInputKeyDown}
                  />
                  <button className="btn btn-primary" onClick={addTodo} disabled={!value.trim()}>
                    Add
                  </button>
                </div>

                {filtered.length === 0 ? (
                  <div className="todo-empty">No tasks under the current filter.</div>
                ) : (
                  <ul className="todo-list">
                    {filtered.map((todo) => (
                      <li className="todo-item" key={todo.id}>
                        <input
                          className="todo-check"
                          type="checkbox"
                          checked={todo.done}
                          onInput={() => toggleTodo(todo.id)}
                        />
                        <span className={joinClasses("todo-text", todo.done ? "done" : "")}>
                          {todo.text}
                        </span>
                        <button
                          className="btn btn-ghost"
                          onClick={() => removeTodo(todo.id)}
                          aria-label="Delete"
                          title="Delete"
                        >
                          Delete
                        </button>
                      </li>
                    ))}
                  </ul>
                )}

                <div className="footer">
                  <div className="row">
                    <button
                      className={joinClasses("btn btn-outline", filter === "all" ? "active" : "")}
                      onClick={() => setFilter("all")}
                    >
                      All
                    </button>
                    <button
                      className={joinClasses("btn btn-outline", filter === "active" ? "active" : "")}
                      onClick={() => setFilter("active")}
                    >
                      Active
                    </button>
                    <button
                      className={joinClasses("btn btn-outline", filter === "done" ? "active" : "")}
                      onClick={() => setFilter("done")}
                    >
                      Completed
                    </button>
                  </div>
                  <div className="row">
                    <span className="badge">{leftCount} remaining</span>
                    <button className="btn btn-danger" onClick={clearDone}>
                      Clear completed
                    </button>
                    <button className="btn btn-ghost" onClick={resetDemo}>
                      Reset demo
                    </button>
                    <button className="btn btn-outline" onClick={copyShareLink}>
                      Copy share link
                    </button>
                  </div>
                </div>

                <div className="hash-hint">
                  <span>Hash field: </span>
                  <code>#state64=&lt;base64url(json)&gt;</code>
                  {flash ? (
                    <div
                      style={{
                        marginTop: "6px",
                        color: "#0f766e",
                        fontWeight: "600",
                      }}
                    >
                      {flash}
                    </div>
                  ) : null}
                </div>

                <p className="muted" style={{ marginTop: "12px", fontSize: "12px" }}>
                  Tip: manually editing the hash updates state after hashchange.
                </p>
              </div>
            </section>
          </main>
        );
      }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="module">
      import { renderPlanInBrowser } from "../../packages/runtime/dist/runtime.esm.js";

      const appElement = document.getElementById("app");
      const statusElement = document.getElementById("runtime-status");
      const sourceElement = document.getElementById("todo-source");

      function setStatus(message) {
        statusElement.textContent = message;
      }

      function toErrorMessage(error) {
        if (error instanceof Error) {
          return error.message;
        }
        return String(error);
      }

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      const sourceCode = sourceElement?.textContent?.trim();
      if (!sourceCode) {
        throw new Error("todo-source payload is empty");
      }
      const localOrigin = window.location.origin;
      const moduleManifest = {
        preact: {
          resolvedUrl: `${localOrigin}/node_modules/preact/dist/preact.module.js`,
        },
        "preact/hooks": {
          resolvedUrl: `${localOrigin}/node_modules/preact/hooks/dist/hooks.module.js`,
        },
        "preact/jsx-runtime": {
          resolvedUrl: `${localOrigin}/node_modules/preact/jsx-runtime/dist/jsxRuntime.module.js`,
        },
        "preact/jsx-dev-runtime": {
          resolvedUrl: `${localOrigin}/node_modules/preact/jsx-runtime/dist/jsxRuntime.module.js`,
        },
      };

      const plan = {
        specVersion: "runtime-plan/v1",
        id: "todo_runtimeplan_hash_demo",
        version: 1,
        root: {
          type: "element",
          tag: "section",
          children: [{ type: "text", value: "Preparing hash todo demo..." }],
        },
        imports: ["preact", "preact/hooks", "preact/jsx-runtime", "preact/jsx-dev-runtime"],
        moduleManifest,
        capabilities: {
          domWrite: true,
        },
        source: {
          language: "jsx",
          runtime: "preact",
          exportName: "default",
          code: sourceCode,
        },
      };

      async function boot() {
        setStatus("Rendering RuntimePlan...");
        try {
          const result = await renderPlanInBrowser(plan, {
            target: "#app",
            autoPinLatestModuleManifest: false,
            securityInitialization: {
              profile: "balanced",
              overrides: {
                allowedNetworkHosts: ["ga.jspm.io", "cdn.jspm.io", window.location.host],
              },
            },
          });
          setStatus(`RuntimePlan rendered: ${result.execution.planId}`);
          window.__RENDERIFY_TODO_HASH_DEMO__ = {
            planId: result.execution.planId,
            diagnostics: result.execution.diagnostics,
          };
        } catch (error) {
          const message = toErrorMessage(error);
          setStatus(`RuntimePlan failed: ${message}`);
          appElement.innerHTML = `<div class="todo-empty">${escapeHtml(message)}</div>`;
          console.error(error);
        }
      }

      void boot();
    </script>
  </body>
</html>
